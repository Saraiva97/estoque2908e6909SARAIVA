<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Peças por Produto</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header-container {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      height: 60px;
      margin-right: 20px;
    }
    h1 {
      color: var(--primary-color);
      margin: 0;
      border-bottom: none;
      padding-bottom: 0;
      flex-grow: 1;
    }
    .upload-section {
      margin: 20px 0;
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      text-align: center;
      background-color: var(--light-color);
    }
    .progress-container {
      width: 100%;
      background-color: #f1f1f1;
      border-radius: 5px;
      margin-top: 15px;
      display: none;
      height: 20px;
      position: relative;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background-color: var(--secondary-color);
      border-radius: 5px;
      transition: width 0.1s;
    }
    .progress-text {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 20px;
      color: var(--primary-color);
      font-weight: bold;
    }
    button {
      background-color: var(--secondary-color);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    #exportBtn {
      background-color: #27ae60;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      margin-left: auto;
    }
    #exportBtn:hover {
      background-color: #219653;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    tr:hover {
      background-color: #e9e9e9;
    }
    .search-container {
      margin-bottom: 20px;
      position: relative;
    }
    #productSearch {
      width: 100%;
      padding: 12px 15px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .summary-card {
      background-color: var(--light-color);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      border-left: 5px solid var(--secondary-color);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .summary-card-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .summary-card-item h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: var(--primary-color);
    }
    .summary-card-item .value {
      font-size: 20px;
      font-weight: bold;
      margin: 5px 0;
    }
    .summary-card-item .sub-value {
      font-size: 14px;
      color: #666;
    }
    .positive {
      color: var(--success-color);
    }
    .negative {
      color: var(--danger-color);
    }
    .neutral {
      color: var(--dark-color);
    }
    .details-btn {
      background-color: var(--secondary-color);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.3s;
    }
    .details-btn:hover {
      background-color: #2980b9;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      width: 85%;
      max-width: 900px;
      margin: 3% auto;
      overflow: hidden;
      border-top: 5px solid var(--secondary-color);
      position: relative;
    }
    .modal-header {
      background: var(--primary-color);
      color: white;
      padding: 20px;
      border-bottom: none;
      position: relative;
    }
    .modal-title {
      font-weight: 600;
      font-size: 1.5rem;
      margin: 0;
    }
    .product-card {
      background: white;
      margin: 20px;
      overflow: hidden;
    }
    .product-header {
      background: #f8f9fa;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .product-title {
      font-size: 1.2rem;
      color: var(--primary-color);
      margin: 0;
      font-weight: 600;
    }
    .product-meta {
      display: flex;
      gap: 15px;
      color: #7f8c8d;
      font-size: 0.9rem;
      flex-wrap: wrap;
    }
    .balance-container {
      display: flex;
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
    }
    .balance-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      min-width: 150px;
    }
    .balance-value {
      font-size: 1.3rem;
      font-weight: bold;
      display: block;
    }
    .transactions-container {
      padding: 0 20px 20px;
    }
    .transactions-title {
      color: var(--primary-color);
      font-size: 1.1rem;
      margin: 20px 0 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--secondary-color);
    }
    .detail-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    .detail-table th {
      background: var(--primary-color);
      color: white;
      padding: 12px 10px;
      text-align: left;
      position: sticky;
      top: 0;
    }
    .detail-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
    }
    .detail-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .detail-table tr:hover {
      background-color: #f1f8e9;
    }
    .type-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .type-entry {
      background-color: #E8F5E9;
      color: #2E7D32;
    }
    .type-return {
      background-color: #FFEBEE;
      color: #C62828;
    }
    .company-tag {
      background: #E3F2FD;
      color: #1565C0;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
    }
    .company-header {
      background-color: #d4edda;
      font-weight: bold;
    }
    .filter-container {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #companySelect, #balanceFilter {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ddd;
      min-width: 200px;
    }
    .close {
      color: white;
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    .close:hover {
      color: var(--accent-color);
    }
    .selected-row {
      background-color: #d4edff !important;
      box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
    }
    .data-warning {
      background-color: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 20px;
      font-size: 0.9rem;
      border-left: 5px solid #ffeeba;
    }
    .value-item {
      text-align: right;
      font-family: monospace;
    }
    .copyright {
      text-align: center;
      margin-top: 30px;
      color: #7f8c8d;
      font-size: 0.9rem;
      padding: 10px;
    }
    .modal-copyright {
      text-align: center;
      padding: 10px;
      color: #7f8c8d;
      font-size: 0.8rem;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-container">
      <img src="Saraiva.jpeg" alt="Logo SaraivaCompany" class="logo">
      <h1>Controle de Peças por Produto</h1>
    </div>

    <div class="upload-section">
      <h3>Carregar Planilha</h3>
      <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" />
      <button id="analyzeBtn">Analisar</button>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
        <div class="progress-text" id="progressText">0%</div>
      </div>
    </div>

    <div class="filter-container" id="companyFilter" style="display: none;">
      <div class="filter-group">
        <label for="companySelect">Razão Social:</label>
        <select id="companySelect">
          <option value="TODAS">Todas as Empresas</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="balanceFilter">Filtrar por Saldo:</label>
        <select id="balanceFilter">
          <option value="TODOS">Todos os Produtos</option>
          <option value="POSITIVO">Produtos com Saldo Positivo</option>
          <option value="NEGATIVO">Produtos com Saldo Negativo</option>
        </select>
      </div>
      <button id="exportBtn">Exportar Planilha</button>
    </div>

    <div class="summary-card" id="summarySection" style="display: none;">
      <div class="summary-card-item">
        <h3>Total de Produtos</h3>
        <div class="value" id="totalProducts">0</div>
        <div class="sub-value">Valor Total</div>
        <div class="value" id="totalValue">R$ 0,00</div>
      </div>
      <div class="summary-card-item">
        <h3>Total de Entradas</h3>
        <div class="value" id="totalEntries">0</div>
        <div class="sub-value">Valor de Entradas</div>
        <div class="value" id="totalEntriesValue">R$ 0,00</div>
      </div>
      <div class="summary-card-item">
        <h3>Total de Retornos</h3>
        <div class="value" id="totalReturns">0</div>
        <div class="sub-value">Valor de Retornos</div>
        <div class="value" id="totalReturnsValue">R$ 0,00</div>
      </div>
      <div class="summary-card-item">
        <h3>Saldo Atual</h3>
        <div class="value" id="currentBalance">0</div>
        <div class="sub-value">Valor de Saldo</div>
        <div class="value" id="currentBalanceValue">R$ 0,00</div>
      </div>
    </div>

    <div class="search-container">
      <input type="text" id="productSearch" placeholder="Pesquisar por código, descrição ou NCM..." />
    </div>

    <table id="productsTable">
      <thead>
        <tr>
          <th>Razão Social</th>
          <th>Código</th>
          <th>Descrição</th>
          <th>NCM</th>
          <th>Unidade</th>
          <th>Entradas (2908)</th>
          <th>Retornos (6909)</th>
          <th>Saldo</th>
          <th>Detalhes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="copyright">
      © SaraivaCompany 2025 - Todos os direitos reservados
    </div>
  </div>

  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
      <div class="modal-copyright">
        © SaraivaCompany 2025
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let allProductsData = [];
    let companies = new Set();
    let productsByCompany = {};
    let currentlySelectedRow = null;
    let allProducts = [];

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("analyzeBtn").addEventListener("click", analyzeFile);
      document.getElementById("productSearch").addEventListener("input", updateSummaryAndFilter);
      document.getElementById("companySelect").addEventListener("change", updateSummaryAndFilter);
      document.getElementById("balanceFilter").addEventListener("change", updateSummaryAndFilter);
      document.getElementById("exportBtn").addEventListener("click", exportToExcel);
      window.addEventListener("click", windowClickHandler);
    });

    function updateProgress(percent) {
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const progressContainer = document.getElementById("progressContainer");
      
      progressBar.style.width = percent + '%';
      progressText.textContent = percent + '%';
      progressContainer.style.display = 'block';
    }

    function formatNumber(value) {
      return new Intl.NumberFormat('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(value);
    }

    function analyzeFile() {
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];

      if (!file) {
        alert("Por favor, selecione um arquivo primeiro.");
        return;
      }

      updateProgress(0);
      
      const reader = new FileReader();
      
      reader.onloadstart = function() {
        updateProgress(5);
      };
      
      reader.onprogress = function(event) {
        if (event.lengthComputable) {
          const percentLoaded = Math.round((event.loaded / event.total) * 45) + 5;
          updateProgress(percentLoaded);
        }
      };

      reader.onload = function (e) {
        updateProgress(55);
        
        setTimeout(() => {
          try {
            updateProgress(60);
            const data = new Uint8Array(e.target.result);
            updateProgress(70);
            const workbook = XLSX.read(data, { type: "array" });
            updateProgress(80);
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            updateProgress(90);
            
            const mappedData = jsonData.map(row => ({
              'Data': row['Data'],
              'Espécie': row['Espécie'],
              'Série': row['Série'],
              'Número': row['Número'],
              'CNPJ / Série SAT': row['CNPJ / Série SAT'],
              'Razão Social': row['Razão Social'],
              'CFOP': row['CFOP'],
              'Produto': row['Produto'],
              'Descrição': row['Descrição']?.toString().trim(),
              'NCM': row['NCM']?.toString().trim(),
              'Quantidade': Number(row['Quantidade']) || 0,
              'Unidade': row['Unidade']?.toString().trim(),
              'Isento ICMS': parseFloat(row['Isento ICMS']) || 0
            }));
            
            updateProgress(95);
            processData(mappedData);
            updateProgress(100);
            
            setTimeout(() => {
              document.getElementById("progressContainer").style.display = 'none';
            }, 500);
            
          } catch (error) {
            console.error("Erro ao processar arquivo:", error);
            alert("Erro ao processar o arquivo. Verifique o formato e tente novamente.");
            document.getElementById("progressContainer").style.display = 'none';
          }
        }, 300);
      };
      
      reader.onerror = function () {
        alert("Erro ao ler o arquivo. Por favor, tente novamente.");
        document.getElementById("progressContainer").style.display = 'none';
      };
      
      reader.readAsArrayBuffer(file);
    }

    function processData(data) {
      const productsMap = new Map();
      allProductsData = data;
      companies = new Set();
      productsByCompany = {};

      data.forEach((row) => {
        const company = row['Razão Social'];
        companies.add(company);
        
        const key = `${row['Produto']}|${company}`;
        const cfop = String(row['CFOP']).trim();
        const quantity = row['Quantidade'];
        const valorTotal = row['Isento ICMS'];
        const valorItem = quantity !== 0 ? (valorTotal / quantity) : 0;

        if (!productsMap.has(key)) {
          productsMap.set(key, {
            code: row['Produto'],
            description: row['Descrição'],
            ncm: row['NCM'],
            unit: row['Unidade'],
            company: company,
            entries: 0,
            returns: 0,
            transactions: []
          });
        }

        const product = productsMap.get(key);
        const transaction = {
          type: cfop === '2908' ? 'Entrada' : 'Retorno',
          cfop: cfop,
          date: row['Data'],
          document: row['Número'],
          cnpj: row['CNPJ / Série SAT'],
          company: company,
          quantity: quantity,
          valorTotal: valorTotal,
          valorItem: valorItem
        };

        product.transactions.push(transaction);

        if (cfop === '2908') {
          product.entries += quantity;
        } else if (cfop === '6909') {
          product.returns += quantity;
        }
      });

      allProducts = Array.from(productsMap.values());
      allProducts.forEach(product => {
        if (!productsByCompany[product.company]) {
          productsByCompany[product.company] = [];
        }
        productsByCompany[product.company].push(product);
      });

      updateCompanyFilter();
      displayProductsGroupedByCompany();
      updateSummary();
    }

    function updateCompanyFilter() {
      const companySelect = document.getElementById("companySelect");
      while (companySelect.options.length > 1) {
        companySelect.remove(1);
      }
      
      const sortedCompanies = Array.from(companies).sort();
      sortedCompanies.forEach(company => {
        const option = document.createElement("option");
        option.value = company;
        option.textContent = company;
        companySelect.appendChild(option);
      });
      
      document.getElementById("companyFilter").style.display = "flex";
      document.getElementById("summarySection").style.display = "grid";
    }

    function updateSummaryAndFilter() {
      updateSummary();
      filterProducts();
    }

    function filterProducts() {
      const searchTerm = document.getElementById("productSearch").value.toLowerCase();
      const selectedCompany = document.getElementById("companySelect").value;
      const selectedBalance = document.getElementById("balanceFilter").value;
      const rows = document.querySelectorAll("#productsTable tbody tr");

      rows.forEach((row) => {
        if (row.classList.contains('company-header')) {
          const companyName = row.textContent.replace('Empresa: ', '').trim();
          const shouldShow = selectedCompany === "TODAS" || companyName === selectedCompany;
          let hasVisibleProducts = false;
          let nextRow = row.nextElementSibling;
          
          while (nextRow && !nextRow.classList.contains('company-header')) {
            if (nextRow.style.display !== 'none') {
              hasVisibleProducts = true;
              break;
            }
            nextRow = nextRow.nextElementSibling;
          }
          
          row.style.display = (shouldShow && hasVisibleProducts) ? "" : "none";
        } else {
          const company = row.cells[0].textContent;
          const productCode = row.cells[1].textContent.toLowerCase();
          const description = row.cells[2].textContent.toLowerCase();
          const ncm = row.cells[3].textContent.toLowerCase();
          const balance = parseInt(row.cells[7].textContent);

          const companyMatch = selectedCompany === "TODAS" || company === selectedCompany;
          const balanceMatch = selectedBalance === "TODOS" || 
                            (selectedBalance === "POSITIVO" && balance > 0) ||
                            (selectedBalance === "NEGATIVO" && balance < 0);
          const searchMatch = 
            company.toLowerCase().includes(searchTerm) || 
            productCode.includes(searchTerm) || 
            description.includes(searchTerm) || 
            ncm.includes(searchTerm);

          row.style.display = (companyMatch && balanceMatch && searchMatch) ? "" : "none";
        }
      });
    }

    function updateSummary() {
      const selectedCompany = document.getElementById("companySelect").value;
      const selectedBalance = document.getElementById("balanceFilter").value;
      const searchTerm = document.getElementById("productSearch").value.toLowerCase();
      
      let filteredProducts = selectedCompany === "TODAS" 
        ? allProducts 
        : allProducts.filter(p => p.company === selectedCompany);

      if (selectedBalance === "POSITIVO") {
        filteredProducts = filteredProducts.filter(p => (p.entries - p.returns) > 0);
      } else if (selectedBalance === "NEGATIVO") {
        filteredProducts = filteredProducts.filter(p => (p.entries - p.returns) < 0);
      }

      if (searchTerm) {
        filteredProducts = filteredProducts.filter(p => 
          p.company.toLowerCase().includes(searchTerm) ||
          p.code.toLowerCase().includes(searchTerm) ||
          (p.description && p.description.toLowerCase().includes(searchTerm)) ||
          (p.ncm && p.ncm.toLowerCase().includes(searchTerm))
        );
      }

      const totalProducts = filteredProducts.length;
      const totalEntries = filteredProducts.reduce((sum, p) => sum + p.entries, 0);
      const totalReturns = filteredProducts.reduce((sum, p) => sum + p.returns, 0);
      const totalBalance = totalEntries - totalReturns;

      const totalEntriesValue = filteredProducts.reduce((sum, p) => {
        return sum + p.transactions
          .filter(t => t.type === 'Entrada')
          .reduce((sumT, t) => sumT + parseFloat(t.valorTotal), 0);
      }, 0);

      const totalReturnsValue = filteredProducts.reduce((sum, p) => {
        return sum + p.transactions
          .filter(t => t.type === 'Retorno')
          .reduce((sumT, t) => sumT + parseFloat(t.valorTotal), 0);
      }, 0);

      const totalBalanceValue = totalEntriesValue - totalReturnsValue;
      const totalValue = totalEntriesValue + totalReturnsValue;

      document.getElementById("totalProducts").textContent = totalProducts;
      document.getElementById("totalEntries").textContent = formatNumber(totalEntries);
      document.getElementById("totalReturns").textContent = formatNumber(totalReturns);
      document.getElementById("currentBalance").textContent = formatNumber(totalBalance);

      document.getElementById("totalEntriesValue").textContent = `R$ ${formatNumber(totalEntriesValue)}`;
      document.getElementById("totalReturnsValue").textContent = `R$ ${formatNumber(totalReturnsValue)}`;
      document.getElementById("currentBalanceValue").textContent = `R$ ${formatNumber(totalBalanceValue)}`;
      document.getElementById("totalValue").textContent = `R$ ${formatNumber(totalValue)}`;

      const balanceEl = document.getElementById("currentBalance");
      balanceEl.className = totalBalance > 0 ? "value positive" : totalBalance < 0 ? "value negative" : "value neutral";
      
      const balanceValueEl = document.getElementById("currentBalanceValue");
      balanceValueEl.className = totalBalanceValue > 0 ? "value positive" : totalBalanceValue < 0 ? "value negative" : "value neutral";
    }

    function highlightSelectedRow(row) {
      if (currentlySelectedRow) {
        currentlySelectedRow.classList.remove('selected-row');
      }
      row.classList.add('selected-row');
      currentlySelectedRow = row;
    }

    function displayProductsGroupedByCompany() {
      const tableBody = document.querySelector("#productsTable tbody");
      tableBody.innerHTML = "";

      const sortedCompanies = Object.keys(productsByCompany).sort();

      sortedCompanies.forEach(company => {
        const headerRow = document.createElement("tr");
        headerRow.className = "company-header";
        headerRow.innerHTML = `<td colspan="9"><strong>Empresa:</strong> ${company}</td>`;
        tableBody.appendChild(headerRow);

        productsByCompany[company].forEach((product) => {
          const balance = product.entries - product.returns;
          const balanceClass = balance > 0 ? "positive" : balance < 0 ? "negative" : "neutral";

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${product.company || '-'}</td>
            <td>${product.code}</td>
            <td>${product.description}</td>
            <td>${product.ncm}</td>
            <td>${product.unit}</td>
            <td>${product.entries}</td>
            <td>${product.returns}</td>
            <td class="${balanceClass}">${balance}</td>
            <td><button class="details-btn" onclick="showProductDetails('${product.code}', '${product.company}', event)">Detalhes</button></td>
          `;
          tableBody.appendChild(row);
        });
      });
    }

    function showProductDetails(productCode, company, event) {
      const clickedRow = event.target.closest('tr');
      highlightSelectedRow(clickedRow);

      const productTransactions = allProductsData.filter(item => 
        item['Produto'] === productCode && item['Razão Social'] === company
      );

      if (productTransactions.length === 0) {
        alert("Nenhum dado encontrado para este produto e empresa.");
        return;
      }

      const uniqueDescriptions = [...new Set(productTransactions.map(item => item['Descrição']))];
      const uniqueNcms = [...new Set(productTransactions.map(item => item['NCM']))];
      const uniqueUnits = [...new Set(productTransactions.map(item => item['Unidade']))];
      const uniqueValores = [...new Set(productTransactions.map(item => item['Isento ICMS']))];
      
      const hasVariations = uniqueDescriptions.length > 1 || uniqueNcms.length > 1 || uniqueUnits.length > 1 || uniqueValores.length > 1;

      let warningMessage = '';
      if (hasVariations) {
        warningMessage = `<div class="data-warning"><strong>Atenção:</strong> Este produto possui variações nos dados:`;
        
        if (uniqueDescriptions.length > 1) {
          warningMessage += `<br>• ${uniqueDescriptions.length} descrições diferentes:<br>`;
          uniqueDescriptions.forEach((desc, index) => {
            warningMessage += `&nbsp;&nbsp;&nbsp;${index+1}. ${desc}<br>`;
          });
        }
        if (uniqueNcms.length > 1) {
          warningMessage += `<br>• ${uniqueNcms.length} NCMs diferentes`;
        }
        if (uniqueUnits.length > 1) {
          warningMessage += `<br>• ${uniqueUnits.length} unidades diferentes`;
        }
        if (uniqueValores.length > 1) {
          warningMessage += `<br>• ${uniqueValores.length} valores totais diferentes: `;
          warningMessage += uniqueValores.map(v => formatNumber(v)).join(', ');
        }
        
        warningMessage += `</div>`;
      }

      const productGroup = {
        code: productCode,
        description: productTransactions[0]['Descrição'],
        ncm: productTransactions[0]['NCM'],
        unit: productTransactions[0]['Unidade'],
        entries: 0,
        returns: 0,
        transactions: []
      };

      productTransactions.forEach(item => {
        const quantity = item['Quantidade'];
        const cfop = String(item['CFOP']).trim();
        const valorTotal = item['Isento ICMS'];
        const valorItem = quantity !== 0 ? (valorTotal / quantity) : 0;
        
        if (cfop === '2908') productGroup.entries += quantity;
        else if (cfop === '6909') productGroup.returns += quantity;

        productGroup.transactions.push({
          type: cfop === '2908' ? 'Entrada' : 'Retorno',
          date: item['Data'],
          document: item['Número'],
          quantity: quantity,
          cfop: cfop,
          valorItem: valorItem,
          valorTotal: valorTotal
        });
      });

      const balance = productGroup.entries - productGroup.returns;
      const balanceClass = balance > 0 ? "positive" : balance < 0 ? "negative" : "neutral";

      const modalContent = `
        <div class="modal-header">
            <h2 class="modal-title">Detalhes do Produto: ${productCode}</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="product-card">
            ${warningMessage}
            <div class="product-header">
                <h3 class="product-title">${productGroup.description}</h3>
                <span class="company-tag">${company}</span>
            </div>
            
            <div class="product-meta">
                <span><strong>NCM:</strong> ${productGroup.ncm}</span>
                <span><strong>Unidade:</strong> ${productGroup.unit}</span>
                <span><strong>Valor Total:</strong> R$ ${formatNumber(productGroup.transactions.reduce((sum, t) => sum + parseFloat(t.valorTotal), 0))}</span>
            </div>
            
            <div class="balance-container">
                <div class="balance-item">
                    <span class="balance-label">Entradas</span>
                    <span class="balance-value positive">${productGroup.entries}</span>
                    <span class="balance-value positive">R$ ${formatNumber(productGroup.transactions.filter(t => t.type === 'Entrada').reduce((sum, t) => sum + parseFloat(t.valorTotal), 0))}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Retornos</span>
                    <span class="balance-value negative">${productGroup.returns}</span>
                    <span class="balance-value negative">R$ ${formatNumber(productGroup.transactions.filter(t => t.type === 'Retorno').reduce((sum, t) => sum + parseFloat(t.valorTotal), 0))}</span>
                </div>
                <div class="balance-item">
                    <span class="balance-label">Saldo</span>
                    <span class="balance-value ${balanceClass}">${balance}</span>
                    <span class="balance-value ${balanceClass}">R$ ${formatNumber(productGroup.transactions.filter(t => t.type === 'Entrada').reduce((sum, t) => sum + parseFloat(t.valorTotal), 0) - productGroup.transactions.filter(t => t.type === 'Retorno').reduce((sum, t) => sum + parseFloat(t.valorTotal), 0))}</span>
                </div>
            </div>
            
            <div class="transactions-container">
                <h4 class="transactions-title">Histórico de Movimentações</h4>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Data</th>
                            <th>Documento</th>
                            <th>Quantidade</th>
                            <th>CFOP</th>
                            <th>Valor Item</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productGroup.transactions.map(t => `
                            <tr>
                                <td><span class="type-badge type-${t.type === 'Entrada' ? 'entry' : 'return'}">${t.type}</span></td>
                                <td>${t.date}</td>
                                <td>${t.document}</td>
                                <td>${t.quantity}</td>
                                <td>${t.cfop}</td>
                                <td class="value-item">R$ ${formatNumber(t.valorItem)}</td>
                                <td class="value-item">R$ ${formatNumber(t.valorTotal)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-copyright">
          © SaraivaCompany 2025
        </div>`;

      document.getElementById("modalContent").innerHTML = modalContent;
      document.getElementById("productModal").style.display = "block";
      document.body.style.overflow = 'hidden';
    }

    function exportToExcel() {
      const selectedCompany = document.getElementById("companySelect").value;
      const selectedBalance = document.getElementById("balanceFilter").value;
      const searchTerm = document.getElementById("productSearch").value.toLowerCase();

      let filteredData = allProductsData.filter(item => {
        const companyMatch = selectedCompany === "TODAS" || item['Razão Social'] === selectedCompany;
        
        let balanceMatch = true;
        if (selectedBalance !== "TODOS") {
          const productCode = item['Produto'];
          const company = item['Razão Social'];
          
          const productTransactions = allProductsData.filter(t => 
            t['Produto'] === productCode && t['Razão Social'] === company
          );
          
          const entries = productTransactions
            .filter(t => String(t['CFOP']).trim() === '2908')
            .reduce((sum, t) => sum + (t['Quantidade'] || 0), 0);
          
          const returns = productTransactions
            .filter(t => String(t['CFOP']).trim() === '6909')
            .reduce((sum, t) => sum + (t['Quantidade'] || 0), 0);
          
          const balance = entries - returns;
          
          if (selectedBalance === "POSITIVO") balanceMatch = balance > 0;
          else if (selectedBalance === "NEGATIVO") balanceMatch = balance < 0;
        }
        
        const searchMatch = 
          item['Razão Social'].toLowerCase().includes(searchTerm) ||
          item['Produto'].toLowerCase().includes(searchTerm) ||
          (item['Descrição'] && item['Descrição'].toLowerCase().includes(searchTerm)) ||
          (item['NCM'] && item['NCM'].toLowerCase().includes(searchTerm));
        
        return companyMatch && balanceMatch && searchMatch;
      });

      if (filteredData.length === 0) {
        alert("Nenhum dado encontrado com os filtros atuais.");
        return;
      }

      let fileName = "relatorio";
      if (selectedCompany !== "TODAS") {
        const firstWord = selectedCompany.split(' ')[0].toLowerCase();
        fileName = firstWord.replace(/[^a-z0-9]/g, '');
      }

      const exportData = filteredData.map(item => ({
        "Data": item['Data'],
        "Espécie": item['Espécie'],
        "Série": item['Série'],
        "Número": item['Número'],
        "CNPJ / Série SAT": item['CNPJ / Série SAT'],
        "Razão Social": item['Razão Social'],
        "CFOP": item['CFOP'],
        "Produto": item['Produto'],
        "Descrição": item['Descrição'],
        "NCM": item['NCM'],
        "Quantidade": item['Quantidade'],
        "Unidade": item['Unidade'],
        "CST/CSOSN ICMS": "0",
        "VALOR UNITARIO": item['Quantidade'] !== 0 ? (item['Isento ICMS'] / item['Quantidade']) : 0,
        "VALOR TOTAL": item['Isento ICMS']
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "saraiva");

      XLSX.writeFile(wb, `${fileName}.xlsx`);
    }

    function closeModal() {
      document.getElementById("productModal").style.display = "none";
      document.body.style.overflow = 'auto';
      
      if (currentlySelectedRow) {
        currentlySelectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    function windowClickHandler(event) {
      if (event.target == document.getElementById("productModal")) {
        closeModal();
      }
    }
  </script>
</body>
</html>
